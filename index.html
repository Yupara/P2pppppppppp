<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Зеленый P2P Обмен</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a2b27;
            color: #e6e6e6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2ecc71;
            font-size: 28px;
            margin-bottom: 20px;
        }
        .form-container, .offers-container, .chat-container, .profile-container {
            background: #223c37;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        label {
            display: block;
            margin: 10px 0 5px;
            color: #e6e6e6;
            font-weight: 500;
        }
        input, select, button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #2ecc71;
            border-radius: 6px;
            background: #1a2b27;
            color: #e6e6e6;
            font-size: 16px;
        }
        button {
            background: #2ecc71;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s, background 0.3s;
        }
        button:hover {
            background: #27ae60;
            transform: scale(1.03);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #223c37;
        }
        th, td {
            border: 1px solid #2ecc71;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #27ae60;
            color: #fff;
        }
        .filters, .public-offers {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filters select, .filters input, .public-offers select, .public-offers input {
            width: auto;
            flex: 1;
        }
        .delete-button, .dispute-button {
            padding: 8px;
            width: auto;
            display: inline-block;
        }
        .delete-button { background: #ff7733; }
        .delete-button:hover { background: #ff5500; transform: scale(1.03); }
        .dispute-button { background: #ff4444; }
        .dispute-button:hover { background: #cc0000; transform: scale(1.03); }
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #1a2b27;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .offer-row {
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        button { animation: pulse 1.5s infinite; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Зеленый P2P Обмен</h1>
        <div class="form-container" id="authSection">
            <h2 id="authTitle">Регистрация</h2>
            <form id="authForm">
                <label>Почта:</label>
                <input type="email" id="email" required>
                <label>Телефон:</label>
                <input type="tel" id="phone" required>
                <label>Пароль:</label>
                <input type="password" id="password" required>
                <label>Реферальный код (опционально):</label>
                <input type="text" id="referralCode">
                <button type="submit" id="authButton">Зарегистрироваться</button>
                <button type="button" onclick="toggleAuth()">Войти</button>
            </form>
            <div id="verificationCode" style="display:none;">
                <label>Код подтверждения:</label>
                <input type="text" id="verifyCode" required>
                <button type="button" onclick="verifyEmail()">Подтвердить</button>
            </div>
        </div>
        <div class="form-container" id="offerSection" style="display:none;">
            <h2>Создать заявку</h2>
            <form id="exchangeForm">
                <label>Продаю:</label>
                <select name="sellCurrency">
                    <option value="USDT">USDT</option><option value="BTC">BTC</option><option value="ETH">ETH</option>
                    <option value="RUB">RUB</option><option value="USD">USD</option><option value="EUR">EUR</option>
                    <option value="GBP">GBP</option><option value="CNY">CNY</option><option value="JPY">JPY</option>
                    <option value="KZT">KZT</option><option value="UAH">UAH</option>
                </select>
                <label>Сумма:</label>
                <input type="number" name="sellAmount" required>
                <label>Покупаю:</label>
                <select name="buyCurrency">
                    <option value="RUB">RUB</option><option value="USDT">USDT</option><option value="BTC">BTC</option>
                    <option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option>
                    <option value="CNY">CNY</option><option value="JPY">JPY</option><option value="KZT">KZT</option>
                    <option value="UAH">UAH</option>
                </select>
                <label>Метод оплаты:</label>
                <select name="paymentMethod">
                    <option value="Bank">Банковская карта</option><option value="Payeer">Payeer</option><option value="AdvCash">AdvCash</option>
                    <option value="PayPal">PayPal</option><option value="Wise">Wise</option><option value="Revolut">Revolut</option>
                    <option value="Skrill">Skrill</option><option value="Neteller">Neteller</option><option value="WebMoney">WebMoney</option>
                    <option value="Qiwi">Qiwi</option><option value="YandexMoney">ЮMoney</option><option value="PerfectMoney">Perfect Money</option>
                    <option value="Zelle">Zelle</option><option value="Venmo">Venmo</option><option value="CashApp">CashApp</option>
                </select>
                <label>Контакт:</label>
                <input type="text" name="contact" required>
                <button type="submit">Создать заявку</button>
            </form>
        </div>
        <div class="form-container" id="filterSection" style="display:none;">
            <h2>Фильтры</h2>
            <div class="filters">
                <select id="filterSellCurrency"><option value="">Все продают</option><option value="USDT">USDT</option><option value="BTC">BTC</option><option value="ETH">ETH</option><option value="RUB">RUB</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="CNY">CNY</option><option value="JPY">JPY</option><option value="KZT">KZT</option><option value="UAH">UAH</option></select>
                <select id="filterBuyCurrency"><option value="">Все покупают</option><option value="RUB">RUB</option><option value="USDT">USDT</option><option value="BTC">BTC</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="CNY">CNY</option><option value="JPY">JPY</option><option value="KZT">KZT</option><option value="UAH">UAH</option></select>
                <select id="filterPayment"><option value="">Все методы</option><option value="Bank">Банковская карта</option><option value="Payeer">Payeer</option><option value="AdvCash">AdvCash</option><option value="PayPal">PayPal</option><option value="Wise">Wise</option><option value="Revolut">Revolut</option><option value="Skrill">Skrill</option><option value="Neteller">Neteller</option><option value="WebMoney">WebMoney</option><option value="Qiwi">Qiwi</option><option value="YandexMoney">ЮMoney</option><option value="PerfectMoney">Perfect Money</option><option value="Zelle">Zelle</option><option value="Venmo">Venmo</option><option value="CashApp">CashApp</option></select>
                <input type="number" id="filterAmount" placeholder="Мин. сумма">
                <button onclick="applyFilters()">Применить</button>
            </div>
        </div>
        <div class="offers-container" id="offersSection" style="display:none;">
            <h2>Публичные заявки</h2>
            <div class="public-offers">
                <select id="publicSellCurrency"><option value="">Все продают</option><option value="USDT">USDT</option><option value="BTC">BTC</option><option value="ETH">ETH</option><option value="RUB">RUB</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="CNY">CNY</option><option value="JPY">JPY</option><option value="KZT">KZT</option><option value="UAH">UAH</option></select>
                <select id="publicBuyCurrency"><option value="">Все покупают</option><option value="RUB">RUB</option><option value="USDT">USDT</option><option value="BTC">BTC</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="CNY">CNY</option><option value="JPY">JPY</option><option value="KZT">KZT</option><option value="UAH">UAH</option></select>
                <select id="publicPayment"><option value="">Все методы</option><option value="Bank">Банковская карта</option><option value="Payeer">Payeer</option><option value="AdvCash">AdvCash</option><option value="PayPal">PayPal</option><option value="Wise">Wise</option><option value="Revolut">Revolut</option><option value="Skrill">Skrill</option><option value="Neteller">Neteller</option><option value="WebMoney">WebMoney</option><option value="Qiwi">Qiwi</option><option value="YandexMoney">ЮMoney</option><option value="PerfectMoney">Perfect Money</option><option value="Zelle">Zelle</option><option value="Venmo">Venmo</option><option value="CashApp">CashApp</option></select>
                <button onclick="loadPublicOffers()">Показать</button>
            </div>
            <table id="publicOffersTable">
                <thead><tr><th>Продаю</th><th>Сумма</th><th>Покупаю</th><th>Метод</th><th>Контакт</th><th>Действие</th></tr></thead>
                <tbody id="publicOffersBody"></tbody>
            </table>
        </div>
        <div class="offers-container" id="myOffersSection" style="display:none;">
            <h2>Мои заявки</h2>
            <table id="offersTable">
                <thead><tr><th>Продаю</th><th>Сумма</th><th>Покупаю</th><th>Метод</th><th>Контакт</th><th>Статус</th><th>Действие</th></tr></thead>
                <tbody id="offersBody"></tbody>
            </table>
        </div>
        <div class="chat-container" id="chatSection" style="display:none;">
            <h2>Чат</h2>
            <div class="chat-messages" id="chatMessages"></div>
            <form id="chatForm"><input type="text" id="chatMessage" placeholder="Сообщение" required><button type="submit">Отправить</button></form>
        </div>
        <div class="support-container" id="supportSection" style="display:none;">
            <h2>Поддержка</h2>
            <form id="supportForm"><label>Сообщение:</label><input type="text" name="message" required><button type="submit">Отправить</button></form>
        </div>
        <div class="profile-container" id="profileSection" style="display:none;">
            <h2>Профиль</h2>
            <p>Сделок выполнено: <span id="tradesCompleted">0</span></p>
            <p>Баланс: <span id="balance">0 USDT</span></p>
            <form id="depositForm"><label>Пополнить:</label><input type="text" id="depositNetwork" placeholder="Сеть"><input type="text" id="depositAddress" placeholder="Адрес"><button type="submit">Пополнить</button></form>
            <p>Реферальный код: <span id="referralCodeDisplay"></span></p>
            <button onclick="withdrawFunds()">Вывести</button>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        const ADMIN_EMAIL = "your-admin-email@example.com";
        let currentUser = null;
        let currentOfferId = null;
        let verificationCode = null;

        function toggleAuth() {
            const title = document.getElementById('authTitle');
            const button = document.getElementById('authButton');
            const toggleButton = document.querySelector('#authForm button[type="button"]');
            if (title.textContent === 'Регистрация') {
                title.textContent = 'Войти';
                button.textContent = 'Войти';
                toggleButton.textContent = 'Регистрация';
                document.getElementById('phone').style.display = 'none';
                document.getElementById('referralCode').style.display = 'none';
            } else {
                title.textContent = 'Регистрация';
                button.textContent = 'Зарегистрироваться';
                toggleButton.textContent = 'Войти';
                document.getElementById('phone').style.display = 'block';
                document.getElementById('referralCode').style.display = 'block';
            }
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const phone = document.getElementById('phone').value;

            if (document.getElementById('authTitle').textContent === 'Регистрация') {
                try {
                    const response = await functions.httpsCallable('sendVerificationCode')({ email, phone });
                    verificationCode = response.data.code;
                    document.getElementById('authForm').style.display = 'none';
                    document.getElementById('verificationCode').style.display = 'block';
                    alert('Код подтверждения отправлен на вашу почту!');
                } catch (error) {
                    alert('Ошибка: ' + error.message);
                }
            } else {
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    alert('Ошибка: ' + error.message);
                }
            }
        });

        document.getElementById('verificationCode').addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON') {
                const code = document.getElementById('verifyCode').value;
                if (code === verificationCode) {
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const phone = document.getElementById('phone').value;
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).set({
                        email, phone, referralCode: Math.random().toString(36).substr(2, 8), tradesCompleted: 0,
                        balance: 0, cancellations: 0, verified: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Регистрация успешна! Ожидайте верификации.');
                } else {
                    alert('Неверный код подтверждения!');
                }
            }
        });

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                if (!userData.verified) {
                    alert('Ожидайте верификации администратором.');
                    auth.signOut();
                    return;
                }
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('offerSection').style.display = 'block';
                document.getElementById('filterSection').style.display = 'block';
                document.getElementById('myOffersSection').style.display = 'block';
                document.getElementById('supportSection').style.display = 'block';
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('offersSection').style.display = 'block';
                loadUserData();
                loadOffers();
                loadPublicOffers();
            } else {
                currentUser = null;
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('offerSection').style.display = 'none';
                document.getElementById('filterSection').style.display = 'none';
                document.getElementById('myOffersSection').style.display = 'none';
                document.getElementById('supportSection').style.display = 'none';
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('offersSection').style.display = 'none';
            }
        });

        document.getElementById('exchangeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const offer = {
                userId: currentUser.uid, sellCurrency: formData.get('sellCurrency'),
                sellAmount: parseFloat(formData.get('sellAmount')), buyCurrency: formData.get('buyCurrency'),
                paymentMethod: formData.get('paymentMethod'), contact: formData.get('contact'),
                status: 'active', buyerId: null, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('offers').add(offer);
            e.target.reset();
            alert('Заявка создана!');
        });

        async function loadOffers() {
            const offersBody = document.getElementById('offersBody');
            offersBody.innerHTML = '';
            const snapshot = await db.collection('offers').where('userId', '==', currentUser.uid).get();
            snapshot.forEach(doc => {
                const offer = doc.data();
                const row = document.createElement('tr');
                row.className = 'offer-row';
                row.innerHTML = `<td>${offer.sellCurrency}</td><td>${offer.sellAmount}</td><td>${offer.buyCurrency}</td><td>${offer.paymentMethod}</td><td>${offer.contact}</td><td>${offer.status}</td><td>${offer.userId === currentUser.uid ? `<button class="delete-button" onclick="deleteOffer('${doc.id}')">Удалить</button>` : ''}${offer.buyerId && offer.userId === currentUser.uid ? `<button onclick="confirmReceived('${doc.id}')">Получил</button>` : ''}${offer.status === 'in-progress' ? `<button class="dispute-button" onclick="openDispute('${doc.id}')">Спор</button>` : ''}</td>`;
                offersBody.appendChild(row);
            });
        }

        async function deleteOffer(offerId) {
            if (confirm('Вы уверены?')) {
                await db.collection('offers').doc(offerId).delete();
                loadOffers();
            }
        }

        async function buyOffer(offerId, amount, currency) {
            const offerRef = db.collection('offers').doc(offerId);
            const offer = (await offerRef.get()).data();
            if (offer.status !== 'active' || offer.userId === currentUser.uid) return;
            await offerRef.update({ buyerId: currentUser.uid, status: 'in-progress' });
            setTimeout(async () => {
                const updatedOffer = (await offerRef.get()).data();
                if (updatedOffer.status === 'in-progress' && !updatedOffer.buyerConfirmed) {
                    await offerRef.update({ status: 'active', buyerId: null });
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    const userData = userDoc.data();
                    await db.collection('users').doc(currentUser.uid).update({ cancellations: userData.cancellations + 1 });
                    if (userData.cancellations + 1 >= 10) {
                        await db.collection('users').doc(currentUser.uid).update({ blockedUntil: new Date(Date.now() + 24 * 60 * 60 * 1000) });
                        alert('Заблокировано на 24 часа из-за 10 отмен!');
                    }
                    alert('Сделка отменена из-за отсутствия ответа!');
                }
            }, 15 * 60 * 1000);
            loadOffers();
            loadPublicOffers();
        }

        async function confirmPayment(offerId) {
            const offerRef = db.collection('offers').doc(offerId);
            await offerRef.update({ buyerConfirmed: true });
            alert('Оплата подтверждена! Ожидание продавца.');
        }

        async function confirmReceived(offerId) {
            const offerRef = db.collection('offers').doc(offerId);
            const offer = (await offerRef.get()).data();
            if (!offer.buyerConfirmed) return alert('Покупатель не подтвердил оплату!');
            let commissionRate = 0.005;
            const sellerDoc = await db.collection('users').doc(offer.userId).get();
            const buyerDoc = await db.collection('users').doc(offer.buyerId).get();
            const sellerData = sellerDoc.data();
            const buyerData = buyerDoc.data();
            if (sellerData.tradesCompleted >= 50 || buyerData.tradesCompleted >= 50) commissionRate = 0.0025;
            let commission = offer.sellAmount * commissionRate * 2;
            if (offer.sellCurrency !== 'USDT') {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether&vs_currencies=usd');
                const prices = await response.json();
                if (offer.sellCurrency === 'BTC') commission = commission / prices.bitcoin.usd;
                if (offer.sellCurrency === 'ETH') commission = commission / prices.ethereum.usd;
            }
            await db.collection('users').doc(offer.userId).update({ tradesCompleted: sellerData.tradesCompleted + 1 });
            await db.collection('users').doc(offer.buyerId).update({ tradesCompleted: buyerData.tradesCompleted + 1 });
            await db.collection('transactions').add({ offerId, commission, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            const referrals = await db.collection('referrals').where('referredId', 'in', [offer.userId, offer.buyerId]).get();
            referrals.forEach(async (ref) => {
                const refData = ref.data();
                const referralBonus = commission * 0.2;
                await db.collection('users').doc(refData.referrerId).update({ balance: firebase.firestore.FieldValue.increment(referralBonus) });
            });
            await offerRef.update({ status: 'completed' });
            alert(`Сделка завершена! Комиссия: ${commission.toFixed(2)} USDT`);
            loadOffers();
            loadPublicOffers();
            notifyUsers(offerId, 'completed');
        }

        async function openDispute(offerId) {
            const screenshot = prompt('Введите URL скриншота:');
            const video = prompt('Введите URL видео (опционально):');
            await db.collection('disputes').add({ offerId, screenshot, video: video || '', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            await db.collection('offers').doc(offerId).update({ status: 'disputed' });
            alert('Спор открыт! Средства заморожены.');
            loadOffers();
            loadPublicOffers();
        }

        async function applyFilters() {
            const sellCurrency = document.getElementById('filterSellCurrency').value;
            const buyCurrency = document.getElementById('filterBuyCurrency').value;
            const payment = document.getElementById('filterPayment').value;
            const amount = document.getElementById('filterAmount').value;
            let query = db.collection('offers').where('status', '==', 'active');
            if (sellCurrency) query = query.where('sellCurrency', '==', sellCurrency);
            if (buyCurrency) query = query.where('buyCurrency', '==', buyCurrency);
            if (payment) query = query.where('paymentMethod', '==', payment);
            if (amount) query = query.where('sellAmount', '>=', parseFloat(amount));
            const snapshot = await query.get();
            const offersBody = document.getElementById('offersBody');
            offersBody.innerHTML = '';
            snapshot.forEach(doc => {
                const offer = doc.data();
                const row = document.createElement('tr');
                row.className = 'offer-row';
                row.innerHTML = `<td>${offer.sellCurrency}</td><td>${offer.sellAmount}</td><td>${offer.buyCurrency}</td><td>${offer.paymentMethod}</td><td>${offer.contact}</td><td>${offer.status}</td><td><button onclick="buyOffer('${doc.id}', ${offer.sellAmount}, '${offer.sellCurrency}')">Купить</button>${offer.buyerId === currentUser.uid ? '<button onclick="confirmPayment(\'' + doc.id + '\')">Оплатил</button>' : ''}</td>`;
                offersBody.appendChild(row);
            });
        }

        async function loadPublicOffers() {
            const sellCurrency = document.getElementById('publicSellCurrency').value;
            const buyCurrency = document.getElementById('publicBuyCurrency').value;
            const payment = document.getElementById('publicPayment').value;
            let query = db.collection('offers').where('status', '==', 'active');
            if (sellCurrency) query = query.where('sellCurrency', '==', sellCurrency);
            if (buyCurrency) query = query.where('buyCurrency', '==', buyCurrency);
            if (payment) query = query.where('paymentMethod', '==', payment);
            const snapshot = await query.get();
            const offersBody = document.getElementById('publicOffersBody');
            offersBody.innerHTML = '';
            snapshot.forEach(doc => {
                const offer = doc.data();
                const row = document.createElement('tr');
                row.className = 'offer-row';
                row.innerHTML = `<td>${offer.sellCurrency}</td><td>${offer.sellAmount}</td><td>${offer.buyCurrency}</td><td>${offer.paymentMethod}</td><td>${offer.contact}</td><td><button onclick="buyOffer('${doc.id}', ${offer.sellAmount}, '${offer.sellCurrency}')">Купить</button></td>`;
                offersBody.appendChild(row);
            });
        }

        async function openChat(offerId) {
            currentOfferId = offerId;
            document.getElementById('chatSection').style.display = 'block';
            loadMessages();
        }

        async function loadMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            const snapshot = await db.collection('messages').where('offerId', '==', currentOfferId).orderBy('createdAt').get();
            snapshot.forEach(doc => {
                const msg = doc.data();
                chatMessages.innerHTML += `<p><strong>${msg.userId === currentUser.uid ? 'Вы' : 'Другой'}:</strong> ${msg.text}</p>`;
            });
        }

        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('chatMessage').value;
            await db.collection('messages').add({ offerId: currentOfferId, userId: currentUser.uid, text: message, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('chatMessage').value = '';
            loadMessages();
        });

        document.getElementById('supportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = e.target.message.value;
            if (message.toLowerCase().includes('оператор')) {
                await functions.httpsCallable('notifyAdmin')({ userId: currentUser.uid, message });
                alert('Оператор уведомлён!');
            } else {
                alert('Сообщение отправлено! Ответ: Опишите проблему подробнее.');
            }
            e.target.reset();
        });

        async function loadUserData() {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            document.getElementById('tradesCompleted').textContent = userData.tradesCompleted;
            document.getElementById('balance').textContent = `${userData.balance || 0} USDT`;
            document.getElementById('referralCodeDisplay').textContent = userData.referralCode;

            document.getElementById('depositForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const network = document.getElementById('depositNetwork').value;
                const address = document.getElementById('depositAddress').value;
                alert(`Пополните на ${network}: ${address}`);
                await db.collection('users').doc(currentUser.uid).update({ balance: firebase.firestore.FieldValue.increment(0) }); // Placeholder
            });

            async function withdrawFunds() {
                const amount = prompt('Введите сумму для вывода (USDT):');
                if (amount && userData.balance >= amount) {
                    alert(`Вывод ${amount} USDT на ваш кошелёк!`);
                    await db.collection('users').doc(currentUser.uid).update({ balance: firebase.firestore.FieldValue.increment(-amount) });
                    loadUserData();
                } else {
                    alert('Недостаточно средств!');
                }
            }
        }

        async function notifyUsers(offerId, status) {
            const offer = (await db.collection('offers').doc(offerId).get()).data();
            const users = [offer.userId, offer.buyerId].filter(Boolean);
            users.forEach(async (userId) => {
                await functions.httpsCallable('sendNotification')({ userId, offerId, status });
            });
        }
    </script>
</body>
</html>
