<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Детали сделки</title>
  <style>
    body { background: #002b26; color: white; font-family: sans-serif; padding: 20px; }
    .chat { background: #004d3f; padding: 15px; border-radius: 10px; max-width: 600px; margin: auto; }
    .message { margin: 10px 0; }
    .me { color: #90ee90; }
    .other { color: #fff; }
  </style>
</head>
<body>
  <h1>Сделка #<span id="orderIdText"></span></h1>
  <div class="chat" id="chatBox"></div>

  <textarea id="msgInput" placeholder="Введите сообщение..." rows="3" cols="50"></textarea><br>
  <button onclick="send()">Отправить</button>

  <script>
    const orderId = new URLSearchParams(window.location.search).get('id');
    document.getElementById('orderIdText').innerText = orderId;

    const token = localStorage.getItem("token");

    function load() {
      fetch(`/api/chat/${orderId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const box = document.getElementById("chatBox");
        box.innerHTML = "";
        data.forEach(msg => {
          const div = document.createElement("div");
          div.className = "message " + (msg.sender_id === getUserId() ? "me" : "other");
          div.innerText = msg.content;
          box.appendChild(div);
        });
      });
    }

    function send() {
      const content = document.getElementById("msgInput").value;
      fetch("/api/chat", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ order_id: Number(orderId), content })
      }).then(() => {
        document.getElementById("msgInput").value = "";
        load();
      });
    }

    function getUserId() {
      const tokenPayload = JSON.parse(atob(token.split('.')[1]));
      return tokenPayload.sub;
    }

    load();
    setInterval(load, 3000);  // обновлять каждые 3 секунды
  </script>
</body>
</html>
