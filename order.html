<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Детали сделки</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <header>Сделка</header>
    <div class="container">
        <h2>Информация о сделке</h2>
        <div class="ad-item">
            <p><strong>ID сделки:</strong> {{ order.id }}</p>
            <p><strong>Продавец:</strong> {{ order.seller_username }}</p>
            <p><strong>Покупатель:</strong> {{ order.buyer_username }}</p>
            <p><strong>Сумма:</strong> {{ order.amount }} {{ order.currency }}</p>
            <p><strong>Статус:</strong> {{ order.status }}</p>

            <div>
                {% if order.status == 'WAITING_PAYMENT' %}
                    <button class="action-button" onclick="markAsPaid()">Я оплатил</button>
                {% elif order.status == 'WAITING_CONFIRMATION' %}
                    <button class="action-button" onclick="markAsConfirmed()">Подтвердить получение</button>
                {% endif %}
                {% if order.status != 'COMPLETED' %}
                    <button class="action-button" onclick="openDispute()">Открыть спор</button>
                {% endif %}
            </div>
        </div>

        <h3>Чат со второй стороной</h3>
        <div class="chat-box" id="chat-box">
            {% for msg in messages %}
                <p><strong>{{ msg.sender }}:</strong> {{ msg.content }}</p>
            {% endfor %}
        </div>

        <form method="post" action="/orders/{{ order.id }}/message">
            <input type="text" name="message" class="chat-input" placeholder="Введите сообщение">
            <button type="submit" class="chat-send">Отправить</button>
        </form>
    </div>

    <script>
        function markAsPaid() {
            fetch(`/orders/{{ order.id }}/mark_paid`, { method: "POST" })
                .then(() => location.reload());
        }

        function markAsConfirmed() {
            fetch(`/orders/{{ order.id }}/mark_confirmed`, { method: "POST" })
                .then(() => location.reload());
        }

        function openDispute() {
            fetch(`/orders/{{ order.id }}/dispute`, { method: "POST" })
                .then(() => location.reload());
        }
    </script>
</body>
</html>
