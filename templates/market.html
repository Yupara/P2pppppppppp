<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Сделка P2P</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body {
      background: #002b26;
      color: #fff;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #003f35;
    }
    header h1 {
      margin: 0;
      color: #90EE90;
    }
    .settings {
      font-size: 1.2rem;
      cursor: pointer;
      color: #90EE90;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .ad-details,
    .order-section,
    .chat-section {
      background: #003f35;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .ad-details h2,
    .order-section h2,
    .chat-section h2 {
      margin-top: 0;
      color: #FFD700;
    }
    .ad-details p,
    .order-section p {
      margin: 6px 0;
    }
    .order-section form {
      display: inline-block;
      margin-right: 10px;
    }
    .order-section button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-warning { background: #FFA500; color: #003300; }
    .btn-success { background: #28a745; color: #fff; }
    .btn-danger  { background: #dc3545; color: #fff; }
    .chat-box {
      background: #002b26;
      border: 1px solid #90EE90;
      border-radius: 4px;
      height: 180px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
    }
    .chat-box p {
      margin: 6px 0;
    }
    .chat-section form {
      display: flex;
    }
    .chat-section input {
      flex: 1;
      padding: 8px;
      border: 1px solid #90EE90;
      border-radius: 4px 0 0 4px;
      background: #002b26;
      color: #fff;
    }
    .chat-section button {
      padding: 8px 12px;
      border: none;
      border-radius: 0 4px 4px 0;
      background: #90EE90;
      color: #003300;
      cursor: pointer;
    }
    .timer {
      text-align: right;
      color: #FFD700;
      font-weight: bold;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Сделка №{{ order.id }}</h1>
    <div class="settings" onclick="location.href='/profile'">⚙️</div>
  </header>
  <div class="container">
    <!-- Детали объявления -->
    <div class="ad-details">
      <h2>Информация об объявлении</h2>
      <p><strong>Тип:</strong> {{ order.ad.type == 'buy' and 'Покупка' or 'Продажа' }}</p>
      <p><strong>Криптовалюта:</strong> {{ order.ad.crypto }}</p>
      <p><strong>Фиат:</strong> {{ order.ad.fiat }}</p>
      <p><strong>Курс:</strong> {{ order.ad.price }} {{ order.ad.fiat }}</p>
      <p><strong>Мин/Макс:</strong> {{ order.ad.min_limit }} – {{ order.ad.max_limit }} {{ order.ad.fiat }}</p>
      <p><strong>Методы оплаты:</strong> {{ order.ad.payment_methods.replace(',', ', ') }}</p>
      <p><strong>Продавец:</strong> {{ order.ad.user.username }} ({{ order.ad.user_rating }}%)</p>
      <div class="timer" id="timer">Осталось времени: 30:00</div>
    </div>

    <!-- Управление сделкой -->
    <div class="order-section">
      <h2>Управление сделкой</h2>
      <p><strong>Статус:</strong> {{ order.status }}</p>
      <form method="post" action="/pay/{{ order.id }}">
        <button type="submit" class="btn-warning">Я оплатил</button>
      </form>
      <form method="post" action="/confirm/{{ order.id }}">
        <button type="submit" class="btn-success">Подтвердить получение</button>
      </form>
      <form method="post" action="/dispute/{{ order.id }}">
        <button type="submit" class="btn-danger">Открыть спор</button>
      </form>
    </div>

    <!-- Чат -->
    <div class="chat-section">
      <h2>Чат</h2>
      <div class="chat-box">
        {% for msg in messages %}
          <p><strong>{{ msg.sender.username }}:</strong> {{ msg.text }}</p>
        {% endfor %}
      </div>
      <form method="post" action="/message/{{ order.id }}">
        <input name="text" placeholder="Написать сообщение..." required>
        <button type="submit">Отправить</button>
      </form>
    </div>
  </div>

  <script>
    // Таймер 30 минут
    let totalSec = 30 * 60;
    const timerEl = document.getElementById('timer');
    function tick() {
      const m = String(Math.floor(totalSec / 60)).padStart(2,'0');
      const s = String(totalSec % 60).padStart(2,'0');
      timerEl.textContent = `Осталось времени: ${m}:${s}`;
      if (totalSec > 0) {
        totalSec--;
        setTimeout(tick, 1000);
      } else {
        timerEl.textContent = 'Сделка просрочена';
      }
    }
    tick();
  </script>
</body>
</html>
