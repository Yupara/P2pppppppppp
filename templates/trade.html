{% extends "base.html" %}
{% block title %}Сделка №{{trade.id}}{% endblock %}
{% block content %}
  <h1>Сделка №{{trade.id}}</h1>

  <div class="trade-info">
    <p><strong>Крипта:</strong> {{trade.crypto}}</p>
    <p><strong>Фиат:</strong> {{trade.fiat}}</p>
    <p><strong>Сумма:</strong> {{trade.amount}}</p>
    <p><strong>Метод оплаты:</strong> {{trade.payment_method}}</p>
    <p><strong>Статус:</strong> {{trade.status}}</p>
    <p><strong>Таймер:</strong> <span id="timer"></span></p>
  </div>

  <div class="actions">
    {% if is_buyer and trade.status=="pending" %}
      <form action="/trade/{{trade.id}}/pay" method="post"><button>Я оплатил</button></form>
    {% endif %}
    {% if is_seller and trade.status=="paid" %}
      <form action="/trade/{{trade.id}}/confirm" method="post"><button>Подтвердить получение</button></form>
    {% endif %}
    {% if trade.status in ["pending","paid"] %}
      <form action="/trade/{{trade.id}}/dispute" method="post"><button>Открыть спор</button></form>
    {% endif %}
  </div>

  <h2>Чат</h2>
  <div class="chat">
    {% for m in messages %}
      <div class="message">
        <p><strong>{{m.sender_uuid}}:</strong> {{m.content}}</p>
        {% if m.file_path %}
          <img src="/{{ m.file_path }}" alt="file" style="max-width:200px;"/>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <form action="/trade/{{trade.id}}/message" method="post" enctype="multipart/form-data" class="chat-form">
    <input type="text" name="text" placeholder="Сообщение..." />
    <input type="file" name="file" accept="image/*" />
    <button type="submit">Отправить</button>
  </form>

  <script>
    const expires = new Date("{{trade.expires_at.isoformat()}}");
    const el = document.getElementById("timer");
    function tick() {
      let diff = expires - new Date();
      if(diff<=0){ el.textContent="Время вышло"; return; }
      let m=Math.floor(diff/60000), s=Math.floor((diff%60000)/1000);
      el.textContent = m + ":" + (s<10?"0"+s:s);
    }
    setInterval(tick, 1000);
    tick();
  </script>
{% endblock %}
