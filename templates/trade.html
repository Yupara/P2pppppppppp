<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Сделка</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script>
    let seconds = {{ remaining }};
    function tick() {
      const el = document.getElementById('timer');
      const m = Math.floor(seconds/60), s = seconds%60;
      el.innerText = `${m}:${String(s).padStart(2,'0')}`;
      if(seconds>0) { seconds--; setTimeout(tick,1000); }
    }
    window.onload = tick;
  </script>
</head>
<body class="dark-theme">
  <div class="container">
    <h1>Сделка</h1>
    <p><strong>Тип:</strong> {{ ad.action }}</p>
    <p><strong>Крипта:</strong> {{ ad.crypto }}</p>
    <p><strong>Фиат:</strong> {{ ad.fiat }}</p>
    <p><strong>Курс:</strong> {{ ad.rate }}</p>
    <p><strong>Оплата:</strong> {{ ad.payment_method }}</p>
    <p class="timer">Осталось: <span id="timer">15:00</span></p>

    <h2>Покупка {{ ad.crypto }}</h2>
    <form action="/trade/{{ ad.id }}/buy" method="post">
      <input type="number" name="usdt_amount" step="0.0001" placeholder="Сумма USDT" required>
      <button class="btn">Купить</button>
    </form>

    <div class="info-box">
      <h3>Итоги сделки</h3>
      <!-- Здесь можно вывести расчет на клиенте с JS -->
      <p class="note">После нажатия «Купить» расчёт отобразится здесь.</p>
    </div>

    <h2>Оплата</h2>
    {% if payments.get(ad.id) and payments[ad.id].paid %}
      <p>Карта: **** **** **** {{ payments[ad.id].card.slice(-4) }}</p>
      <p>Статус: Оплачено</p>
    {% else %}
      <form action="/trade/{{ ad.id }}/pay" method="post">
        <input type="text" name="card_number" placeholder="Номер карты" required>
        <input type="text" name="exp_date" placeholder="MM/YY" required>
        <input type="text" name="cvv" placeholder="CVV" required>
        <button class="btn">Платеж выполнен</button>
      </form>
    {% endif %}
    <h2>Подтверждение получения</h2>
    {% if receipts.get(ad.id) %}
      <p>USDT получен продавцом ✅</p>
    {% else %}
      <form action="/trade/{{ ad.id }}/confirm_receipt" method="post">
        <button class="btn btn-success">Я получил USDT</button>
      </form>
    {% endif %}

    <h2>Чат</h2>
    <div class="chat-box">
      {% for msg in messages %}
        <p><strong>{{ msg.user }}:</strong> {{ msg.text }}</p>
      {% endfor %}
    </div>
    <form action="/trade/{{ ad.id }}/message" method="post">
      <input type="text" name="message" placeholder="Сообщение" required>
      <button class="btn">Отправить</button>
    </form>

    <a href="/market"><button class="btn">Назад</button></a>
  </div>
</body>
</html>
