<!-- templates/trade.html -->
{% extends "base.html" %}

{% block title %}Сделка №{{ trade.id }}{% endblock %}

{% block content %}
  <h1>Сделка №{{ trade.id }}</h1>

  <div class="trade-info">
    <p><strong>Объявление:</strong> {{ trade.ad.crypto }}/{{ trade.ad.fiat }}</p>
    <p><strong>Сумма:</strong> {{ trade.amount }} {{ trade.ad.crypto }}</p>
    <p><strong>Цена:</strong> {{ trade.ad.price }} {{ trade.ad.fiat }}</p>
    <p><strong>Статус:</strong> {{ trade.status }}</p>
    <p><strong>Окончание срока оплаты:</strong> <span id="timer"></span></p>
  </div>

  <div class="actions">
    {% if is_buyer and trade.status == "pending" %}
      <form action="/trade/{{ trade.id }}/paid" method="post">
        <button>Я оплатил</button>
      </form>
    {% endif %}
    {% if is_seller and trade.status == "paid" %}
      <form action="/trade/{{ trade.id }}/confirm" method="post">
        <button>Подтвердить получение</button>
      </form>
    {% endif %}
    {% if trade.status in ["pending","paid"] %}
      <form action="/trade/{{ trade.id }}/dispute" method="post">
        <button>Открыть спор</button>
      </form>
    {% endif %}
  </div>

  <h2>Чат</h2>
  <div class="chat">
    {% for m in messages %}
      <p><strong>{{ m.sender_uuid }}:</strong> {{ m.content }}</p>
    {% endfor %}
  </div>

  <form action="/trade/{{ trade.id }}/message" method="post" class="chat-form">
    <input name="content" placeholder="Ваше сообщение..." required>
    <button type="submit">Отправить</button>
  </form>

  <script>
    // Таймер обратного отсчёта
    const expiresAt = new Date("{{ trade.expires_at.isoformat() }}");
    const timerEl = document.getElementById("timer");
    function updateTimer() {
      const now = new Date("{{ now }}");
      let diff = expiresAt - new Date();
      if (diff <= 0) {
        timerEl.textContent = "Время вышло";
        clearInterval(interval);
        return;
      }
      const m = Math.floor(diff / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      timerEl.textContent = m + ":" + (s < 10 ? "0"+s : s);
    }
    const interval = setInterval(updateTimer, 1000);
    updateTimer();
  </script>
{% endblock %}
