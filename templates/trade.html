<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–¥–µ–ª–∫–∞</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script>
    // –¢–∞–π–º–µ—Ä 15 –º–∏–Ω—É—Ç
    let seconds = {{ remaining }};
    function tick() {
      const el = document.getElementById('timer');
      const m = Math.floor(seconds / 60), s = seconds % 60;
      el.innerText = `${m}:${String(s).padStart(2, '0')}`;
      if (seconds > 0) {
        seconds--;
        setTimeout(tick, 1000);
      }
    }
    window.onload = tick;

    // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function toggleSettings() {
      const menu = document.getElementById('settingsMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    window.onclick = e => {
      if (e.target.id === 'settingsMenu') toggleSettings();
    };
  </script>
</head>
<body class="dark-theme">
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div class="navbar">
    <a href="/market">üè† –†—ã–Ω–æ–∫</a>
    <a href="/create">‚ûï –û–±—ä—è–≤–ª–µ–Ω–∏–µ</a>
    <div class="settings-icon" onclick="toggleSettings()">‚öôÔ∏è</div>
  </div>

  <!-- –ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <div id="settingsMenu" class="settings-menu">
    <p>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ ad.owner }}</p>
    <p>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ—Ä–¥–µ—Ä–æ–≤: {{ ad.completed_orders }}</p>
    <p>‚≠ê –†–µ–π—Ç–∏–Ω–≥: {{ ad.rating }}%</p>
    <p>üí≥ –û–ø–ª–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {{ ad.payment_method }}</p>
    <p><button onclick="location.href='/deposit'">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button> <button onclick="location.href='/withdraw'">–í—ã–≤–µ—Å—Ç–∏</button></p>
    <p>üîó –ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞: <a href="#">0x1234...abcd</a></p>
  </div>

  <div class="container">
    <h2>–°–¥–µ–ª–∫–∞ —Å {{ ad.owner }}</h2>

    <div class="info-box">
      <p><strong>–¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏—è:</strong> {{ ad.title }}</p>
      <p><strong>–¶–µ–Ω–∞:</strong> {{ ad.price }} –∑–∞ 1 {{ ad.title }}</p>
      <p><strong>–î–æ—Å—Ç—É–ø–Ω–æ:</strong> {{ ad.amount }} {{ ad.title }}</p>
      <p><strong>–õ–∏–º–∏—Ç—ã:</strong> –æ—Ç {{ ad.min_limit }} –¥–æ {{ ad.max_limit }} {{ ad.payment_method }}</p>
      <p><strong>–£—Å–ª–æ–≤–∏—è:</strong> {{ ad.condition }}</p>
      <p class="timer">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏: <span id="timer">15:00</span></p>
    </div>

    <!-- –§–æ—Ä–º–∞ –ø–æ–∫—É–ø–∫–∏ -->
    {% if order_status.get(ad.id) not in ['released','cancelled'] %}
    <form class="form" action="/trade/{{ ad.id }}/buy" method="post">
      <label>–°–∫–æ–ª—å–∫–æ {{ ad.title }} –∫—É–ø–∏—Ç—å:</label>
      <input type="number" name="amount" step="0.0001" placeholder="{{ ad.min_limit }}‚Äì{{ ad.max_limit }}" required>
      <button class="btn">–ö—É–ø–∏—Ç—å</button>
    </form>
    {% endif %}

    <!-- –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã -->
    {% if order_status.get(ad.id)=='pending' %}
    <div class="info-box">
      <h3>–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π</h3>
      <form class="form" action="/trade/{{ ad.id }}/pay" method="post">
        <input type="text" name="card_number" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã" required>
        <input type="text" name="exp_date" placeholder="MM/YY" required>
        <input type="text" name="cvv" placeholder="CVV" required>
        <button class="btn">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
      </form>
    </div>
    {% endif %}

    <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è / –°–ø–æ—Ä / –û—Ç–º–µ–Ω–∞ -->
    <div class="info-box">
      <p><strong>–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏:</strong> {{ order_status.get(ad.id,'pending')|capitalize }}</p>

      {% if order_status.get(ad.id)=='paid' %}
      <form action="/trade/{{ ad.id }}/confirm_receipt" method="post" style="display:inline-block">
        <button class="btn btn-success">–Ø –ø–æ–ª—É—á–∏–ª {{ ad.title }}</button>
      </form>
      <form action="/trade/{{ ad.id }}/dispute" method="post" style="display:inline-block">
        <button class="btn btn-warning">–û—Ç–∫—Ä—ã—Ç—å —Å–ø–æ—Ä</button>
      </form>
      {% endif %}

      {% if order_status.get(ad.id)=='pending' %}
      <form action="/trade/{{ ad.id }}/cancel" method="post">
        <button class="btn btn-danger">–û—Ç–º–µ–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
      </form>
      {% endif %}

      {% if order_status.get(ad.id)=='released' %}
      <p>‚úÖ –°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.</p>
      {% elif order_status.get(ad.id)=='cancelled' %}
      <p>‚ùå –°–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.</p>
      {% elif order_status.get(ad.id)=='disputed' %}
      <p>‚ö†Ô∏è –°–¥–µ–ª–∫–∞ –≤ —Å–ø–æ—Ä–µ. –û–∂–∏–¥–∞–µ—Ç—Å—è —Ä–µ—à–µ–Ω–∏–µ.</p>
      {% endif %}
    </div>

    <!-- –ß–∞—Ç -->
    <h3>–ß–∞—Ç —Å–¥–µ–ª–∫–∏</h3>
    <form class="form" action="/trade/{{ ad.id }}/message" method="post" enctype="multipart/form-data">
      <input type="text" name="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." required>
      <input type="file" name="image" accept="image/*">
      <button class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>

    <div class="chat">
      {% for msg in messages %}
      <div class="chat-message">
        <strong>{{ msg.user }}:</strong> {{ msg.text }}
        {% if msg.image_url %}
        <div><img src="{{ msg.image_url }}" class="chat-image"></div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
</body>
</html>
