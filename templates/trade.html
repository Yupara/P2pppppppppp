<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Сделка</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script>
    // Таймер 15 минут
    let seconds = 15*60;
    function tick(){
      const el = document.getElementById('timer');
      const m = Math.floor(seconds/60), s = seconds%60;
      el.innerText = `${m}:${String(s).padStart(2,'0')}`;
      if(seconds>0){ seconds--; setTimeout(tick,1000); }
    }
    window.onload = tick;
  </script>
</head>
<body class="dark-theme">
  <div class="container">
    <h1>Сделка</h1>
    <div class="field"><strong>Цена:</strong> {{ad.price}} {{ad.fiat}}</div>
    <div class="field"><strong>Сумма:</strong> {{ad.amount}} {{ad.crypto}}</div>
    <div class="field"><strong>Оплата:</strong> {{ad.payment_method}}</div>
    <div class="field timer">Осталось: <span id="timer">15:00</span></div>

    <h2>Введите</h2>
    <div class="field">
      <label>RUB → USDT</label><br>
      <input id="sum_rub" type="number" placeholder="₽" oninput="usd.value=''; calc()">
      <input id="sum_usdt" type="number" placeholder="USDT" oninput="sum_rub.value=''; calc()">
    </div>
    <script>
      function calc(){
        const price = {{ad.rate}};
        const r = document.getElementById('sum_rub').value;
        const u = document.getElementById('sum_usdt').value;
        if(r) document.getElementById('sum_usdt').value=(r/price).toFixed(6);
        if(u) document.getElementById('sum_rub').value=(u*price).toFixed(2);
      }
    </script>

    <button class="btn">Купить</button>

    <div class="info-box">
      <h3>Условия мейкера</h3>
      <p>{{ad.comment or 'Без дополнительных условий'}}</p>
    </div>

    <div class="info-box">
      <h3>Продавец</h3>
      <p>Ник: Павел</p>
      <p>Рейтинг: 99%</p>
      <p>Ордера: 55</p>
    </div>

    <h2>Чат</h2>
    <div class="chat-box">
      {% for msg in ad.chat %}
        <p><strong>{{msg.user}}:</strong> {{msg.text}}</p>
      {% endfor %}
    </div>
    <form method="post" action="/trade/{{ad.id}}/message">
      <input type="text" name="message" placeholder="Сообщение" required>
      <button class="btn">Отправить</button>
    </form>
  </div>
</body>
</html>
