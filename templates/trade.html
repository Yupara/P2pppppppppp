<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Сделка</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    /* Настройки (reuse from market) */
    .header { display:flex; justify-content:space-between; align-items:center; background:#161b22; padding:10px 20px; border-bottom:1px solid #30363d; }
    .icon-btn { background:none; border:none; color:#c9d1d9; font-size:1.5rem; cursor:pointer; }
    .modal { display:none; position:fixed; z-index:999; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); }
    .modal-content { background:#161b22; margin:10% auto; padding:20px; border:1px solid #30363d; border-radius:6px; width:300px; color:#c9d1d9; }
    .close-btn { float:right; cursor:pointer; color:#c9d1d9; font-size:1.2rem; }
  </style>
  <script>
    let seconds = {{ remaining }};
    function tick(){
      const el=document.getElementById('timer'), m=Math.floor(seconds/60), s=seconds%60;
      el.innerText=`${m}:${String(s).padStart(2,'0')}`;
      if(seconds>0){ seconds--; setTimeout(tick,1000); }
    }
    window.onload=tick;
    function openSettings(){document.getElementById('settingsModal').style.display='block';}
    function closeSettings(){document.getElementById('settingsModal').style.display='none';}
    window.onclick=e=>{ if(e.target.id==='settingsModal') closeSettings(); }
  </script>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <a href="/market" style="color:#58a6ff; text-decoration:none;">← Рынок</a>
    <button class="icon-btn" onclick="openSettings()">⚙️</button>
  </div>

  <!-- Настройки Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeSettings()">✖️</span>
      <h2>Настройки</h2>
      <p><strong>Пользователь:</strong> {{ current_user }}</p>
      <p><strong>Баланс:</strong> {{ balances[current_user] | round(2) }} USDT</p>
      <p><strong>Способ оплаты:</strong> {{ ad.payment_method }}</p>
      <a href="/deposit"><button>Пополнить кошелек</button></a>
      <a href="/withdraw"><button>Вывести средства</button></a>
      <p><strong>Адрес кошелька:</strong><br>
        <a href="#">usdt:ADDRESS123...</a>
      </p>
    </div>
  </div>

  <div class="trade-container">
    <h2>{{ ad.action|capitalize }} {{ ad.crypto }}</h2>
    <p>Цена: {{ ad.rate }} {{ ad.fiat }}</p>
    <p>Доступно: {{ ad.amount }} {{ ad.crypto }}</p>
    <p>Лимиты: от {{ ad.min_limit }} до {{ ad.max_limit }} {{ ad.fiat }}</p>
    <p>Продавец: {{ ad.owner }} (Рейтинг {{ ad.rating }}%, Ордеры {{ ad.completed_orders }})</p>
    <p>Условия: {{ ad.comment or '—' }}</p>
    <p>Осталось времени: <span id="timer">15:00</span></p>

    {% if status not in ['released','cancelled'] %}
    <form action="/trade/{{ ad.id }}/buy" method="post">
      <label>Сколько {{ ad.crypto }} купить:</label>
      <input type="number" name="amount" step="0.0001" required>
      <button class="btn">Купить</button>
    </form>
    {% endif %}

    {% if status=='pending' %}
      <form action="/trade/{{ ad.id }}/pay" method="post"><button class="btn">Я оплатил</button></form>
      <form action="/trade/{{ ad.id }}/cancel" method="post"><button class="btn btn-danger">Отменить</button></form>
    {% elif status=='paid' %}
      <form action="/trade/{{ ad.id }}/confirm_receipt" method="post"><button class="btn btn-success">Подтвердить получение</button></form>
      <form action="/trade/{{ ad.id }}/dispute" method="post"><button class="btn btn-warning">Открыть спор</button></form>
    {% elif status=='released' %}
      <p class="success">✅ Сделка завершена</p>
    {% elif status=='cancelled' %}
      <p class="cancelled">❌ Сделка отменена</p>
    {% endif %}

    <hr>
    <h3>Чат</h3>
    <form action="/trade/{{ ad.id }}/message" method="post" enctype="multipart/form-data">
      <textarea name="message" placeholder="Сообщение"></textarea>
      <input type="file" name="image" accept="image/*">
      <button class="btn">Отправить</button>
    </form>
    <div class="messages">
      {% for msg in messages %}
        <div class="message">
          <strong>{{ msg.user }}:</strong> {{ msg.text }}
          {% if msg.image_url %}<br><img src="{{ msg.image_url }}" class="chat-image">{% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</body>
</html>
