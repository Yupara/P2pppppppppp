<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–¥–µ–ª–∫–∞</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script>
    let seconds = {{remaining}};
    function tick(){
      const el=document.getElementById('timer');
      const m=Math.floor(seconds/60), s=seconds%60;
      el.innerText=`${m}:${String(s).padStart(2,'0')}`;
      if(seconds>0){ seconds--; setTimeout(tick,1000); }
    }
    window.onload=tick;
    function calc(){
      const rate = {{ad.rate}};
      const r=document.getElementById('sum_rub').value;
      const u=document.getElementById('sum_usdt').value;
      if(r) document.getElementById('sum_usdt').value=(r/rate).toFixed(6);
      if(u) document.getElementById('sum_rub').value=(u*rate).toFixed(2);
    }
  </script>
</head>
<body class="dark-theme">
  <header class="header">
    <div class="header-left">
      <p class="user-name">üë§ –ü–∞–≤–µ–ª</p>
      <p class="user-info">‚úÖ –û—Ä–¥–µ—Ä–∞: 55</p>
      <p class="user-info">‚≠ê –†–µ–π—Ç–∏–Ω–≥: 99%</p>
      <p class="user-info">üí≥ –û–ø–ª–∞—Ç–∞: –°–±–µ—Ä–±–∞–Ω–∫</p>
    </div>
    <div class="header-right"><button class="icon-btn">üîî</button></div>
  </header>
  <div class="container">
    <h1>–°–¥–µ–ª–∫–∞</h1>
    <p><strong>–¢–∏–ø:</strong> {{ad.action}}</p>
    <p><strong>–ö—Ä–∏–ø—Ç–∞:</strong> {{ad.crypto}}</p>
    <p><strong>–§–∏–∞—Ç:</strong> {{ad.fiat}}</p>
    <p><strong>–ö—É—Ä—Å:</strong> {{ad.rate}} ‚ÇΩ</p>
    <p><strong>–£—Å–ª–æ–≤–∏—è:</strong> {{ad.comment}}</p>
    <p class="timer">–û—Å—Ç–∞–ª–æ—Å—å: <span id="timer">15:00</span></p>

    <h2>–ü–æ–∫—É–ø–∫–∞ {{ad.crypto}}</h2>
    <input id="sum_rub" oninput="document.getElementById('sum_usdt').value='';calc()" type="number" placeholder="‚ÇΩ">
    <input id="sum_usdt" oninput="document.getElementById('sum_rub').value='';calc()" type="number" placeholder="USDT">
    <form action="/trade/{{ad.id}}/buy" method="post">
      <input type="hidden" name="usdt_amount" id="hidden_usdt">
      <button class="btn" onclick="document.getElementById('hidden_usdt').value=document.getElementById('sum_usdt').value;">–ö—É–ø–∏—Ç—å</button>
    </form>

    {% if payments.get(ad.id) and not payments[ad.id].paid %}
    <div class="info-box">
      <h2>–ò—Ç–æ–≥–∏ —Å–¥–µ–ª–∫–∏</h2>
      <p>–°—É–º–º–∞ USDT: {{payments[ad.id].usdt_amount}}</p>
      <p>–ò—Ç–æ–≥ (‚ÇΩ): {{payments[ad.id].total_rub | round(2)}}</p>
      <p>–ö–æ–º–∏—Å—Å–∏—è: {{payments[ad.id].commission | round(2)}} ‚ÇΩ</p>
      <p>–í—Ä–µ–º—è: {{payments[ad.id].timestamp}}</p>
      <h3>–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã</h3>
      <form action="/trade/{{ad.id}}/pay" method="post">
        <input type="text" name="card_number" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã" required>
        <input type="text" name="exp_date" placeholder="MM/YY" required>
        <input type="text" name="cvv" placeholder="CVV" required>
        <button class="btn">–ü–ª–∞—Ç—ë–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω</button>
      </form>
    </div>
    {% endif %}

    {% if payments.get(ad.id) and payments[ad.id].paid %}
      {% if receipts.get(ad.id) %}
        <div class="info-box"><p>USDT –ø–æ–ª—É—á–µ–Ω –ø—Ä–æ–¥–∞–≤—Ü–æ–º ‚úÖ</p></div>
      {% else %}
        <form action="/trade/{{ad.id}}/confirm_receipt" method="post">
          <button class="btn btn-success">–Ø –ø–æ–ª—É—á–∏–ª USDT</button>
        </form>
      {% endif %}
    {% endif %}

    <h2>–ß–∞—Ç</h2>
    <div class="chat-box">
      {% for msg in messages %}<p><strong>{{msg.user}}:</strong> {{msg.text}}</p>{% endfor %}
    </div>
    <form action="/trade/{{ad.id}}/message" method="post">
      <input type="text" name="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" required>
      <button class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>

    <a href="/market"><button class="btn">–ù–∞–∑–∞–¥</button></a>
  </div>
</body>
</html>
