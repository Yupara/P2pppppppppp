{% extends "base.html" %}

{% block title %}Сделка №{{ trade.id }}{% endblock %}

{% block content %}
  <h1>Сделка №{{ trade.id }}</h1>

  <div class="trade-info">
    <p><strong>Объявление:</strong> {{ trade.ad.crypto }}/{{ trade.ad.fiat }}</p>
    <p><strong>Сумма:</strong> {{ trade.amount }}</p>
    <p><strong>Цена:</strong> {{ trade.ad.price }} {{ trade.ad.fiat }}</p>
    <p><strong>Статус:</strong> {{ trade.status }}</p>
    <p><strong>Окончание оплаты:</strong> <span id="timer"></span></p>
  </div>

  <h2>Чат</h2>
  <div class="chat">
    {% for m in messages %}
      <p><strong>{{ m.sender_uuid }}:</strong> {{ m.content }}</p>
    {% endfor %}
  </div>

  <form action="/trade/{{ trade.id }}/message" method="post" class="chat-form">
    <input name="content" placeholder="Ваше сообщение..." required>
    <button type="submit">Отправить</button>
  </form>

  <script>
    const expires = new Date("{{ trade.expires_at.isoformat() }}");
    const el = document.getElementById("timer");
    setInterval(() => {
      let diff = expires - new Date();
      if (diff <= 0) { el.textContent = "Время вышло"; return; }
      let m = Math.floor(diff / 60000), s = Math.floor((diff % 60000)/1000);
      el.textContent = m + ":" + (s<10?"0"+s:s);
    }, 1000);
  </script>
{% endblock %}
