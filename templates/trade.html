{% extends "base.html" %}

{% block title %}Сделка{% endblock %}

{% block content %}
<h2>Сделка #{{ order.id }}</h2>

<p>Вы участвуете в сделке по объявлению пользователя {{ order.ad.user.username }}</p>

<p><strong>Тип:</strong> {{ order.ad.type }}</p>
<p><strong>Криптовалюта:</strong> {{ order.ad.crypto }}</p>
<p><strong>Фиат:</strong> {{ order.ad.fiat }}</p>
<p><strong>Сумма:</strong> {{ order.amount }}</p>
<p><strong>Цена:</strong> {{ order.ad.price }}</p>
<p><strong>Методы оплаты:</strong> {{ order.ad.payment_methods }}</p>

<hr>

<div style="margin-bottom: 20px;">
    {% if current_user.id == order.buyer_id %}
        <form method="post" action="/orders/{{ order.id }}/confirm_payment">
            <button type="submit" class="btn">Я оплатил</button>
        </form>
    {% endif %}

    {% if current_user.id == order.seller_id %}
        <form method="post" action="/orders/{{ order.id }}/release_crypto">
            <button type="submit" class="btn green">Подтвердить получение</button>
        </form>
    {% endif %}

    <form method="post" action="/orders/{{ order.id }}/open_dispute">
        <button type="submit" class="btn red">Открыть спор</button>
    </form>
</div>

<hr>

<h3>Чат</h3>
<div id="chat-box" style="border:1px solid #333;padding:10px;max-height:300px;overflow-y:scroll;">
    {% for msg in messages %}
        <p><strong>{{ msg.sender.username }}:</strong> {{ msg.content }}</p>
    {% endfor %}
</div>

<form method="post" action="/orders/{{ order.id }}/send_message">
    <textarea name="message" required placeholder="Ваше сообщение..." style="width:100%;height:60px;"></textarea>
    <button type="submit" class="btn">Отправить</button>
</form>
{% endblock %}
